---
title: "Stats_report"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(corrplot)
library(car)
library(gstat)
library(sp)
library(spaMM)
library(DHARMa)
library(gridExtra)
library(ggplot2)

source("functions/plot_fixed_effect_relationship.R")
source("functions/plot_model_effects.R")
source("functions/plot_spatial_correlation.R")
```

# Eaton

```{r, echo = F, warning=FALSE} 
Eaton <- read.csv("../model_inputs/eaton_burned_trees_model_inputs.csv") %>% select(-X)

Eaton <- Eaton %>% mutate(burned = if_else(height_diff < 0 & ndvi_diff < -0.2, 1, 0), angular_diff_tree = pmin(abs(bearing_to_nearest_tree - 45), 360 - abs(bearing_to_nearest_tree - 45)), angular_diff_build = pmin(abs(bearing_to_closest_building - 45), 360 - abs(bearing_to_closest_building - 45))) %>% 
  replace_na(list(total_build_2m = 0, total_build_5m = 0, total_build_10m = 0))

```


## View histograms of variables of interest
```{r, echo = FALSE, warning=FALSE, message=FALSE} 

Eaton_long <- Eaton %>% pivot_longer(cols = 2:21)

ggplot(Eaton_long, aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free") +
  theme(strip.text.x = element_text(size = 5), 
        axis.text = element_text(size = 5))

```

```{r, echo = F, warning=FALSE} 
Eaton <- read.csv("Eaton_fire_model_inputs_d1.csv") %>% select(-X)

Eaton <- Eaton %>% mutate(burned = if_else(Postfire_Prefire_CHM_MEAN < 0 & NDVI_post_pre < -0.2, 1, 0), angular_diff_tree = pmin(abs(bearing_to_nearest_tree - 45), 360 - abs(bearing_to_nearest_tree - 45)), angular_diff_build = pmin(abs(bearing_to_closest - 45), 360 - abs(bearing_to_closest - 45))) %>% 
  replace_na(list(total_build_2m = 0, total_build_5m = 0, total_build_10m = 0))

cols <- c("dist_to_nearest_tree", "dist_to_building", "angular_diff_tree", "num_trees_2m", "num_trees_5m", "num_trees_10m", "area_ext_tree_2",  "area_ext_tree_5", "total_build_2m", "total_build_5m", "total_build_10m", "angular_diff_build", "BuildingKernelDensity_MEAN", "TreeKernelDensity_MEAN")

names(cols) <- cols

Eaton_scale <- mutate(Eaton, across(all_of(cols), scale))

Eaton_scale_long <- Eaton_scale %>% pivot_longer(cols = c("dist_to_nearest_tree", "dist_to_building", "angular_diff_tree", "num_trees_2m", "num_trees_5m", "num_trees_10m", "area_ext_tree_2",  "area_ext_tree_5", "total_build_2m", "total_build_5m", "total_build_10m", "angular_diff_build", "BuildingKernelDensity_MEAN", "TreeKernelDensity_MEAN"))

ggplot(Eaton_scale_long, aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free") +
  theme(strip.text.x = element_text(size = 5), 
        axis.text = element_text(size = 5))

```





## Correlation matrix

```{r, echo=FALSE}
Eaton_comp <- Eaton %>% filter(complete.cases(Eaton)) %>% 
  select(dist_to_nearest_building, dist_to_nearest_tree, angular_diff_tree, angular_diff_build, tree_dens, build_dens, area_ext_tree2, total_build_2m, total_build_5m, total_build10)


corrplot(cor(Eaton_comp), tl.cex = .5, method = "number")

```

## Hmm Building Kernel Density appears to be collinear with dist to nearest building, and local severity. 



 

## check spatial autocorrelation

``` {r, echo=FALSE}

lm1 <- lm(planet_ndvi_post_pre_MEAN ~ dist_to_nearest_tree*angular_diff_tree + dist_to_building*angular_diff_build + TreeKernelDensity_MEAN + BuildingKernelDensity_MEAN, data = Eaton)

lm_1_resid <- Eaton %>% select(planet_ndvi_post_pre_MEAN, dist_to_nearest_tree, angular_diff_tree, dist_to_building, angular_diff_build, BuildingKernelDensity_MEAN, TreeKernelDensity_MEAN, utm_x, utm_y) %>% na.omit()

lm_1_resid$resid <- lm1$residuals

ggplot(lm_1_resid, aes(x = utm_x, y = utm_y, color = resid)) +
  geom_point(size = .1)

```

```{r}

coordinates(lm_1_resid) <- ~ utm_x + utm_y

plot(gstat::variogram(resid ~ utm_x + utm_y, data = lm_1_resid, cutoff = 500))

```


```{r}

  Eaton_tree_spamm_1 <- readRDS("~/Desktop/Urban_tree_fire/landscape_analysis/models/Eaton_tree_m1_unscaled.rda")

summary(Eaton_tree_spamm_1)

#Eaton_samp <- read.csv("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_tree_samp_5000.csv")


```

```{r}

  Eaton_tree_spamm_1_comp <- Eaton_tree_spamm_1$data %>% select(dist_to_nearest_building, dist_to_nearest_tree, area_ext_tree2, total_build_2m, build_dens, tree_dens, height_diff)

corrplot(cor(Eaton_tree_spamm_1_comp), tl.cex = .5, method = "number")


```

```{r}

plot_spatial_correlation(Eaton_tree_spamm_1)

```

```{r}

sims <- simulateResiduals(Eaton_tree_spamm_1)

plot(sims)

```


```{r}

gg1 <- plot_fixed_effect_relationship(Eaton_tree_spamm_1, line_col = "red", predictor = "area_ext_tree_2")

gg2 <- plot_fixed_effect_relationship(Eaton_tree_spamm_1, line_col = "forestgreen", predictor = "dist_to_nearest_tree")

lines <- arrangeGrob(gg1, gg2, ncol = 2)

ggsave(plot = lines, "../Figures/Eaton_tree_spamm_1_lines.png")

gg1

gg2

```



```{r}

plot_model_effects(Eaton_tree_spamm_1, plot_title = "Effect sizes height change")

ggsave("../Figures/Eaton_tree_spamm_1_effect_sizes.png")


```

## The above model indicates distance to nearest building, distance to nearest tree, and building kernel density, all had a significant effect on the change in NDVI of tree canopies from pre to post fire. It states that for every meter farther away from a building a tree was the amount of NDVI change decreases by 0.0007765 and for every one meter farther away from a burned tree is the NDVI change decreases by 0.0007278. 


```{r}

  Eaton_tree_ext_spamm_1 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_tree_ext_m1_unscaled.rda")

summary(Eaton_tree_ext_spamm_1)



```

## View histograms of variables of interest
```{r, echo = FALSE, warning=FALSE, message=FALSE} 

Eaton_ext_long <- Eaton_tree_ext_spamm_1$data %>% pivot_longer(cols = 6:22)

ggplot(Eaton_ext_long, aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free") +
  theme(strip.text.x = element_text(size = 5), 
        axis.text = element_text(size = 5))

```






```{r, echo=FALSE}
Eaton_ext_comp <- Eaton_tree_ext_spamm_1$data %>% 
  select(dist_to_building, dist_to_nearest_tree, num_trees_2m, angular_diff_tree, angular_diff_build, TreeKernelDensity_MEAN, BuildingKernelDensity_MEAN)


corrplot(cor(Eaton_ext_comp), tl.cex = .5, method = "number")

```




```{r}

sims <- simulateResiduals(Eaton_tree_ext_spamm_1)

plot(sims)

```


```{r}

gg1 <- plot_fixed_effect_relationship(Eaton_tree_ext_spamm_1, line_col = "red", predictor = "dist_to_building")

gg2 <- plot_fixed_effect_relationship(Eaton_tree_ext_spamm_1, line_col = "forestgreen", predictor = "dist_to_nearest_tree")

lines <- arrangeGrob(gg1, gg2, ncol = 2)

#ggsave(plot = lines, "../Figures/Eaton_tree_spamm_1_lines.png")

gg1

gg2
```




```{r}

plot_model_effects(Eaton_tree_ext_spamm_1, plot_title = "Effect sizes height change")

ggsave("../Figures/Eaton_tree_spamm_1_ext_effect_sizes.png")


```

# Compare fitted slopes Eaton_tree_spamm_1, Eaton_tree_ext_spamm_1

```{r}

 coefs <- fixef(Eaton_tree_spamm_1)
  se <- sqrt(diag(vcov(Eaton_tree_spamm_1)))  # standard errors
  
  # Create data frame of coefficients
  effect_df <- data.frame(
    term = names(coefs),
    estimate = coefs,
    std.error = se,
    lower = coefs - 1.96 * se,
    upper = coefs + 1.96 * se
  )
  
  
   coefs_ext <- fixef(Eaton_tree_ext_spamm_1)
  se_ext <- sqrt(diag(vcov(Eaton_tree_ext_spamm_1)))  # standard errors
  
  # Create data frame of coefficients
  effect_df_ext <- data.frame(
    term = names(coefs_ext),
    estimate = coefs_ext,
    std.error = se_ext,
    lower = coefs_ext - 1.96 * se_ext,
    upper = coefs_ext + 1.96 * se_ext
  )
  
  
  # Calculate Welch's T-test statistic
t_stat <- (effect_df$estimate[4] - effect_df_ext$estimate[4]) / sqrt(effect_df$std.error[4]^2 + effect_df_ext$std.error[4]^2)

# Degrees of freedom
df <- ((effect_df$std.error[4]^2 + effect_df_ext$std.error[4]^2)^2) / (((effect_df$std.error[4]^2)^2 / (28338 - 2)) + ((effect_df_ext$std.error[4]^2)^2 / (26996 - 2)))

# Calculate p-value
p_value <- 2 * pt(-abs(t_stat), df)

# Display the test statistic and p-value
t_stat
p_value


```

```{r}


Eaton_tree_spamm_2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_tree_m1_unscaled.rda")

summary(Eaton_tree_spamm_2)

#pseudoR2(Eaton_tree_spamm_2)

```



```{r}

plot_spatial_correlation(Eaton_tree_spamm_2)

```



```{r}

sims <- simulateResiduals(Eaton_tree_spamm_2)

plot(sims)

```



```{r}

gg1 <- plot_fixed_effect_relationship(Eaton_tree_spamm_2, predictor = "dist_to_building", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Eaton_tree_spamm_2, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

#ggsave(plot = lines, "Figures/Eaton_tree_spamm_2_lines.png")

gg1

gg2

```

```{r}

plot_model_effects(Eaton_tree_spamm_2, plot_title = "Effect sizes NDVI change")

ggsave("../Figures/Eaton_tree_spamm2_effect_sizes.png")

```





#### The above model states that for every one meter farther from a destroyed building that a tree was, it lost ~.0056 less dnvi (greeness) on average. For reference, living trees have an NDVI of >0.2, and rocks have an NDVI of < 0.1. 





#### The above model states that for every one meter farther away a tree was from a destroyed building it lost ~ 10 cm less height on average across its whole canopy. 



```{r}


Eaton_tree_ext_spamm_2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_tree_ext_m2_unscaled.rda")

summary(Eaton_tree_ext_spamm_2)

#pseudoR2(Eaton_tree_spamm_2)

```


```{r}

sims <- simulateResiduals(Eaton_tree_ext_spamm_2)

plot(sims)

```



```{r}

gg1 <- plot_fixed_effect_relationship(Eaton_tree_ext_spamm_2, predictor = "dist_to_building", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Eaton_tree_ext_spamm_2, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

#ggsave(plot = lines, "Figures/Eaton_tree_spamm_2_lines.png")

gg1

gg2

```

```{r}

plot_model_effects(Eaton_tree_ext_spamm_2, plot_title = "Effect sizes NDVI change")

ggsave("../Figures/Eaton_tree_spamm2_ext_effect_sizes.png")

```




```{r}


Eaton_tree_spamm_3 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_m4_output.rda")

summary(Eaton_tree_spamm_3)

```

```{r}

plot_spatial_correlation(Eaton_tree_spamm_3)

```

```{r}

sims <- simulateResiduals(Eaton_tree_spamm_3)

plot(sims)

```


```{r}

gg1 <- plot_fixed_effect_relationship(Eaton_tree_spamm_3, predictor = "dist_to_building", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Eaton_tree_spamm_3, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "Figures/Eaton_tree_spamm_3_lines.png")

lines
```


```{r}
plot_model_effects(Eaton_tree_spamm_3, plot_title = "Effect sizes Burned")

ggsave("../Figures/Eaton_tree_spamm_3_effect_sizes.png")

```



## the above model states that for every one meter farthe away from a tree a tree is the odds that it burned decreased by about 5% and for every one meter farther away from a builidng that a tree was the odds that it burned decreased by about 8%. 



## Eaton Structure stats

```{r, echo = F, warning=FALSE} 

Eaton_struc <- read.csv("~/Desktop/Urban_tree_fire/landscape_analysis/model_inputs/eaton_burned_struc_model_inputs.csv") %>% 
  select(-X) %>% 
  filter(DAMAGE %in% c("Destroyed (>50%)", "No Damage", "Affected (1-9%)")) %>% 
  na.omit()

Eaton_struc <- Eaton_struc %>% mutate(angular_diff_build = pmin(abs(bearing_to_nearest_building - 45), 360 - abs(bearing_to_nearest_building - 45)), angular_diff_tree = pmin(abs(bearing_to_nearest_tree - 45), 360 - abs(bearing_to_nearest_tree - 45)), destroyed = if_else(DAMAGE %in% c("No Damage", "Affected (1-9%)"),0,1))


```

```{r, echo = FALSE, warning=FALSE, message=FALSE} 

Eaton_struc_long <- Eaton_struc %>% pivot_longer(cols = c(7:29))

ggplot(Eaton_struc_long, aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free") +
  theme(strip.text.x = element_text(size = 5), 
        axis.text = element_text(size = 5))

```

```{r}

Eaton_struc_cor <- Eaton_struc %>% select(7:29) %>% 
  drop_na()

corrplot(cor(Eaton_struc_cor), tl.cex = .5, method = "number")

# ggplot(Eaton_struc, aes(y = num_trees_10m, x = utm_x)) +
#   geom_point() +
#   geom_smooth(method = "lm")
# 
# ggplot(Eaton_struc, aes(y = utm_y, x = utm_x, color = destroyed)) +
#   geom_point()
```


``` {r, echo=FALSE}

glm1 <- glm(destroyed ~ dist_to_nearest_tree*angular_diff_tree + dist_to_nearest_struc*angular_diff_build + TreeKernelDensity_MEAN + BuildingKernelDensity_MEAN, data = Eaton_struc)

glm_1_resid <- Eaton_struc %>% select(destroyed, dist_to_nearest_tree, angular_diff_tree, dist_to_nearest_struc, angular_diff_build, BuildingKernelDensity_MEAN, TreeKernelDensity_MEAN, utm_x, utm_y) %>% na.omit()

glm_1_resid$resid <- glm1$residuals

ggplot(glm_1_resid, aes(x = utm_x, y = utm_y, color = resid)) +
  geom_point(size = .1)

```


```{r}

coordinates(glm_1_resid) <- ~ utm_x + utm_y

plot(gstat::variogram(resid ~ utm_x + utm_y, data = glm_1_resid, cutoff = 500))

```



```{r}


Eaton_struc_null <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_struc_null.rda")

summary(Eaton_struc_null)


```





```{r}


Eaton_struc_spamm_1 <- readRDS("~/Desktop/Urban_tree_fire/landscape_analysis/models/Eaton_struc_m1_unscaled.rda")

summary(Eaton_struc_spamm_1)


```



```{r, echo=FALSE}

Eaton_struc_spamm_1_comp <- Eaton_struc_spamm_1$data %>% filter(complete.cases(Eaton_struc_spamm_1$data)) %>% 
  select(distance_to_nearest_tree, distance_to_nearest_building, angular_diff_tree, angular_diff_build,  tree_dens, build_dens, area_of_trees_2m, area_ext_build_2)


corrplot(cor(Eaton_struc_spamm_1_comp), tl.cex = .5, method = "number")

```





```{r}

plot_spatial_correlation(Eaton_struc_spamm_1)

```


```{r}

sims <- simulateResiduals(Eaton_struc_spamm_1)

plot(sims)

```

```{r}

gg1 <- plot_fixed_effect_relationship(Eaton_struc_spamm_1, predictor = "TreeKernelDensity_MEAN", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Eaton_struc_spamm_1, predictor = "BuildingKernelDensity_MEAN", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "../Figures/Eaton_struc_spamm1_lines.png")

lines

```


```{r}

plot_model_effects(Eaton_struc_spamm_1)

ggsave("../Figures/Eaton_struc_spamm1_effect_sizes.png")

```

```{r}

Eaton_struc_spam_2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_")

summary(Eaton_struc_spam_2)

```


```{r, echo=FALSE}

Eaton_struc_spam_2_comp <- Eaton_struc_spam_2$data %>% filter(complete.cases(Eaton_struc_spam_2$data)) %>% 
  select(dist_to_nearest_struc, num_trees_10m, angular_diff_tree, angular_diff_build, local_sev, TreeKernelDensity_MEAN, BuildingKernelDensity_MEAN)


corrplot(cor(Eaton_struc_spam_2_comp), tl.cex = .5, method = "number")

```


```{r}

plot_spatial_correlation(Eaton_struc_spam_2)


```

```{r}

sims <- simulateResiduals(Eaton_struc_spam_2)

plot(sims)

```

```{r}

gg1 <- plot_fixed_effect_relationship(Eaton_struc_spam_2, predictor = "dist_to_nearest_struc", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Eaton_struc_spam_2, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "../Figures/Eaton_struc_spamm_2_lines.png")

lines
```


```{r}

plot_model_effects(Eaton_struc_spam_2)

ggsave("../Figures/Eaton_struc_spamm_2_effect_sizes.png")

```



```{r}

Eaton_struc_spamm_2.1 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_struc_m2_1.rda")

summary(Eaton_struc_spamm_2.1)

plot_model_effects(Eaton_struc_spamm_2.1)

ggsave("../Figures/Eaton_struc_spamm_2.1_effect_sizes.png")

```


```{r}

Eaton_struc_spamm_2.2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_struc_m2_2.rda")

plot_model_effects(Eaton_struc_spamm_2.2)

ggsave("../Figures/Eaton_struc_spamm_2.2_effect_sizes.png")

```



```{r}

Eaton_struc_spamm_3 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_struc_m3.rda")

plot_model_effects(Eaton_struc_spamm_3)

ggsave("../Figures/Eaton_struc_spamm_3_effect_sizes.png")

```



```{r}

Eaton_struc_spamm_3.1 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_struc_m3_1.rda")

plot_model_effects(Eaton_struc_spamm_3.1)

ggsave("../Figures/Eaton_struc_spamm_3.1_effect_sizes.png")

#plot_fixed_effect_relationship(Eaton_struc_spamm_3.1, "area_tree_5m", pred_max = 200)

```







```{r}

Eaton_struc_spamm_3.2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Eaton_struc_m3_2.rda")

plot_model_effects(Eaton_struc_spamm_3.2)

```


```{r}

sims <- simulateResiduals(Eaton_struc_spamm_3.2)

plot(sims)

```








# Palisades

```{r, echo=FALSE} 
Palisades <- read.csv("~/Desktop/Urban_tree_fire/landscape_analysis/model_inputs/palisades_burned_trees_model_inputs.csv") %>% dplyr::select(-X)

Palisades <- Palisades %>% mutate(angular_diff_tree = pmin(abs(bearing_to_nearest_tree - 45), 360 - abs(bearing_to_nearest_tree - 45)), angular_diff_build = pmin(abs(bearing_to_closest_building - 45), 360 - abs(bearing_to_closest_building - 45))) %>% 
  na.omit()

ggplot(Palisades, aes(x = utm_x, y = utm_y)) +
  geom_point()

```

## View histograms of variables of interest

```{r, echo = FALSE, warning=FALSE, message=FALSE} 

Palisades_long <- Palisades %>% pivot_longer(cols = c(6:24))

ggplot(Palisades_long, aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free") +
  theme(strip.text.x = element_text(size = 5), 
        axis.text = element_text(size = 5))

```


## Correlation matrix

```{r, echo=FALSE}

Palisades_cor <- Palisades %>% filter(complete.cases(Palisades)) %>% 
  select(dist_to_nearest_building, dist_to_nearest_tree, angular_diff_tree, angular_diff_build, tree_dens, build_dens)

corrplot(cor(Palisades_cor), tl.cex = .5, method = "number")

```



``` {r, echo=FALSE}

lm1 <- lm(Postfire_Prefire_CHM_MEAN ~ dist_to_building*angular_diff_build + dist_to_nearest_tree*angular_diff_tree + TreeKernelDensity_MEAN + BuildingKernelDensity_MEAN, data = Palisades)


lm1_resid <- Palisades

lm1_resid$resid <- lm1$residuals

ggplot(lm1_resid, aes(x = utm_x, y = utm_y, color = resid)) +
  geom_point(size = .1) +
  scale_color_viridis_c("magma")

```


```{r}

coordinates(lm1_resid) <- ~ utm_x + utm_y

v <- gstat::variogram(resid ~ utm_x + utm_y, data = lm1_resid, cutoff = 100)

plot(v)


```

```{r}

Palisades_tree_spamm_1 <- readRDS("~/Desktop/Urban_tree_fire/landscape_analysis/models/Palisades_tree_m1_unscaled.rda")

summary(Palisades_tree_spamm_1)

```



```{r, echo=FALSE}
Palisades_tree_comp <- Palisades_tree_spamm_1$data %>%
  select(dist_to_nearest_building, dist_to_nearest_tree, area_ext_tree2, angular_diff_tree, angular_diff_build, tree_dens, build_dens)


corrplot(cor(Palisades_tree_comp), tl.cex = .5, method = "number")




```


```{r}

plot_spatial_correlation(Palisades_tree_spamm_1)

```

```{r}

sims <- simulateResiduals(Palisades_tree_spamm_1)

plot(sims)

```


```{r}

gg1 <- plot_fixed_effect_relationship(Palisades_tree_spamm_1, predictor = "dist_to_building", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Palisades_tree_spamm_1, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "../Figures/Palisades_tree_spamm_1_lines.png")

lines

```

#### The above model states that for every one meter farther from a destroyed building that a tree was, it was 0.036 lower NDVI (greeness) on average. For reference, living trees have an NDVI of >0.2, and rocks have an NDVI of < 0.1.


```{r}


plot_model_effects(Palisades_tree_spamm_1, plot_title = "Effect Sizes for Height Change")

ggsave("../Figures/Palisades_trees_spamm_1_effect_sizes.png")
```



```{r}

Palisades_tree_spamm_1_ext <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_tree_m1_ext_unscaled.rda")

summary(Palisades_tree_spamm_1_ext)

```


```{r}

sims <- simulateResiduals(Palisades_tree_spamm_1_ext)

plot(sims)

```



```{r}


plot_model_effects(Palisades_tree_spamm_1_ext, plot_title = "Effect Sizes for Height Change")

ggsave("../Figures/Palisades_trees_spamm_1_ext_effect_sizes.png")
```





```{r}

Palisades_tree_spamm_2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_tree_m2_unscaled.rda")

summary(Palisades_tree_spamm_2)

```

```{r}

plot_spatial_correlation(Palisades_tree_spamm_2)

```


```{r}

sims <- simulateResiduals(Palisades_tree_spamm_2)

plot(sims)

```

```{r}

gg1 <- plot_fixed_effect_relationship(Palisades_tree_spamm_2, predictor = "dist_to_building", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Palisades_tree_spamm_2, predictor = "dist_to_nearest_tree", line_col = "forestgreen")


lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "../Figures/Palisades_trees_spamm_2_lines.png")

lines
```

```{r}

plot_model_effects(Palisades_tree_spamm_2, plot_title = "Effect sizes NDVI Change")

ggsave("../Figures/Palisades_tree_spamm_2_effect_sizes.png")
```


```{r}

Palisades_tree_spamm_2_ext <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_tree_m2_ext_unscaled.rda")

summary(Palisades_tree_spamm_2_ext)

```



```{r}

sims <- simulateResiduals(Palisades_tree_spamm_2_ext)

plot(sims)

```



```{r}

plot_model_effects(Palisades_tree_spamm_2_ext, plot_title = "Effect sizes NDVI Change")

ggsave("../Figures/Palisades_tree_spamm_2_ext_effect_sizes.png")
```




```{r}

Palisades_tree_spamm_3 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_tree_m3.rda")

summary(Palisades_tree_spamm_3)

```



```{r}
plot_spatial_correlation(Palisades_tree_spamm_3)

```


```{r}

sims <- simulateResiduals(Palisades_tree_spamm_3)

plot(sims)

```



```{r}

gg1 <- plot_fixed_effect_relationship(Palisades_tree_spamm_3, predictor = "dist_to_building", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Palisades_tree_spamm_3, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "Figures/Palisades_tree_spamm_3_lines.png")

lines
```



```{r}
plot_model_effects(Palisades_tree_spamm_3)

ggsave("Figures/Palisades_tree_spamm_3_effect_sizes.png")
```


#### The above model says that for every one meter farther away a tree was from a destroyed building it lost ~ 1 cm less height on average across its whole canopy.




```{r}

Palisades_struc <- read.csv("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_fire_model_inputs_struc_1.csv")


Palisades_struc <- Palisades_struc %>% mutate(angular_diff_build = pmin(abs(bearing_to_closest_struc - 45), 360 - abs(bearing_to_closest_struc - 45)), angular_diff_tree = pmin(abs(bearing_to_tree - 45), 360 - abs(bearing_to_tree - 45)), destroyed = if_else(damage == "Destroyed (>50%)",1,0))


Palisades_struc_long <- Palisades_struc %>% pivot_longer(cols = c(5:17))


ggplot(Palisades_struc_long, aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free") +
  theme(strip.text.x = element_text(size = 5), 
        axis.text = element_text(size = 5))


```


## Correlation matrix

```{r, echo=FALSE}

Palisades_struc_cor <- Palisades_struc %>% filter(complete.cases(Palisades_struc)) %>% 
  select(dist_to_nearest_struc, dist_to_nearest_tree, angular_diff_tree, angular_diff_build, num_trees_2m, num_trees_5m, num_trees_10m, area_tree_2m, area_tree_5m, area_tree_10m, local_sev, TreeKernelDensity_MEAN, BuildingKernelDensity_MEAN)

corrplot(cor(Palisades_struc_cor), tl.cex = .5, method = "number")

```


``` {r, echo=FALSE}

glm1 <- glm(destroyed ~ dist_to_nearest_tree*angular_diff_tree + dist_to_nearest_struc*angular_diff_build + TreeKernelDensity_MEAN + BuildingKernelDensity_MEAN, data = Palisades_struc)

glm_1_resid <- Palisades_struc %>% select(destroyed, dist_to_nearest_tree, angular_diff_tree, dist_to_nearest_struc, angular_diff_build, BuildingKernelDensity_MEAN, TreeKernelDensity_MEAN, utm_x, utm_y) %>% na.omit()

glm_1_resid$resid <- glm1$residuals

ggplot(glm_1_resid, aes(x = utm_x, y = utm_y, color = resid)) +
  geom_point(size = .1)

```


```{r}

coordinates(glm_1_resid) <- ~ utm_x + utm_y

plot(gstat::variogram(resid ~ utm_x + utm_y, data = glm_1_resid, cutoff = 500))

```

```{r}


Palisades_struc_null <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades")

summary(Palisades_struc_spamm_1)

```




```{r}


Palisades_struc_spamm_1 <- readRDS("~/Desktop/Urban_tree_fire/landscape_analysis/simple_models/Palisades_struc_m1.rda")

summary(Palisades_struc_spamm_1)

```

```{r, echo=FALSE}
Palisades_comp <- Palisades_struc_spamm_1$data %>% select(distance_to_nearest_tree, 
angular_diff_tree, 
area_of_trees_2m,
area_ext_build_2, 
distance_to_nearest_building, 
angular_diff_build, 
build_dens, 
tree_dens)


corrplot(cor(Palisades_comp), tl.cex = .5, method = "number")




```


```{r}

plot_spatial_correlation(Palisades_struc_spamm_1)


```


```{r}


sims <- simulateResiduals(Palisades_struc_spamm_1)

plot(sims)

```


```{r}

gg1 <- plot_fixed_effect_relationship(Palisades_struc_spamm_1, predictor = "dist_to_nearest_struc", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Palisades_struc_spamm_1, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "../Figures/Palisades_struc_spamm_1_lines.png")

lines

```




```{r}

plot_model_effects(Palisades_struc_spamm_1)

ggsave("../Figures/Palisades_struc_spamm_1_effect_sizes.png")
```



```{r}


Palisades_struc_spamm_2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_struc_m2.rda")

summary(Palisades_struc_spamm_2)

```


```{r, echo=FALSE}

Palisades_struc_spamm_2_comp <- Palisades_struc_spamm_2$data %>% filter(complete.cases(Palisades_struc_spamm_2$data)) %>% 
  select(dist_to_nearest_struc, num_trees_10m, angular_diff_tree, angular_diff_build, local_sev, TreeKernelDensity_MEAN, BuildingKernelDensity_MEAN)


corrplot(cor(Palisades_struc_spamm_2_comp), tl.cex = .5, method = "number")

```



```{r}

plot_spatial_correlation(Palisades_struc_spamm_2)

```

```{r}

gg1 <- plot_fixed_effect_relationship(Palisades_struc_spamm_2, predictor = "dist_to_nearest_struc", line_col = "red")

gg2 <- plot_fixed_effect_relationship(Palisades_struc_spamm_2, predictor = "dist_to_nearest_tree", line_col = "forestgreen")

lines <- grid.arrange(gg1, gg2, ncol = 2)

ggsave(plot = lines, "../Figures/Palisades_struc_spamm_2_lines.png")

lines
```



```{r}

plot_model_effects(Palisades_struc_spamm_2)

ggsave("../Figures/Palisades_struc_spamm_2_effect_sizes.png")

```



```{r}

Palisades_struc_spamm_2.1 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_struc_m2.1.rda")

plot_model_effects(Palisades_struc_spamm_2.1)

ggsave("../Figures/Palisades_struc_spamm_2.1_effect_sizes.png")

```


```{r}

Palisades_struc_spamm_2.2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_struc_m2.2.rda")

summary(Palisades_struc_spamm_2.2)

plot_model_effects(Palisades_struc_spamm_2.2)

ggsave("../Figures/Palisades_struc_spamm_2.2_effect_sizes.png")

```



```{r}

Palisades_struc_spamm_3 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_struc_m3.rda")

plot_model_effects(Palisades_struc_spamm_3)

ggsave("../Figures/Palisades_struc_spamm_3_effect_sizes.png")

```


```{r}

Palisades_struc_spamm_3.1 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_struc_m3.1.rda")

plot_model_effects(Palisades_struc_spamm_3.1)

ggsave("../Figures/Palisades_struc_spamm_3.1_effect_sizes.png")

```


```{r}

Palisades_struc_spamm_3.2 <- readRDS("~/OneDrive - Cal Poly/Analysis_Results/ArcExports/Palisades_struc_m3.2.rda")

plot_model_effects(Palisades_struc_spamm_3.2)

ggsave("../Figures/Palisades_struc_spamm_3.2_effect_sizes.png")

```












