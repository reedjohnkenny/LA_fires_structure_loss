---
title: "structures_only_figs"
output: html_document
---

---
title: "Simple_figures"
output: html_document
---

```{r}

library(dplyr)
library(gridExtra)
library(ggplot2)
library(cowplot)
library(tmap)
library(tmaptools)
library(sf)
library(terra)
library(tigris)
library(grid)
library(corrplot)
library(reshape2)
library(spatialEco)
library(performance)
library(INLA)
library(spaMM)

source("functions/plot_fire_effects.R")
source("functions/plot_model_effects.R")
source("functions/coef_mag.R")
source("functions/make_fire_effects_panel.R")
source("functions/welch_t_test.R")
source("functions/make_model_table.R")
source("functions/make_model_table_struc.R")
source("functions/human_labs.R")
```

## Map

```{r}

eaton_area <- st_read("~/OneDrive - Cal Poly/data/town_polygons/Eaton_clip.shp") %>% st_transform(32611)

eaton_fprints <- st_read("../tmp_data/eaton_burned_fprints.shp")

eaton_fprints_buff <- eaton_fprints %>% 
  st_union() %>% 
  st_buffer(50) %>% 
  st_cast("POLYGON") %>% 
  st_as_sf()

pal_ext <- st_read("~/OneDrive - Cal Poly/data/town_polygons/pal_external.shp") %>% st_transform(32611)

pal_in <- st_read("~/OneDrive - Cal Poly/Advanced_GIS_data/Maxar/Palisades/Palisades_pre/GIS_FILES/016569561010_01_ORDER_SHAPE.shp") %>% st_transform(32611)

eaton_perim_minus50m <- st_read("~/OneDrive - Cal Poly/Data/WFIGS_Interagency_Perimeters_YearToDate_-5395415287356828930/") %>% 
  filter(poly_Incid == "Eaton") %>% 
  st_transform(crs=32611) %>% 
  select(poly_Incid, poly_Featu) %>% 
  st_buffer(-50)

palisades_perim_minus50m <- st_read("~/OneDrive - Cal Poly/Data/WFIGS_Interagency_Perimeters_YearToDate_-5395415287356828930/") %>% 
  st_transform(crs = 32611) %>% 
  filter(poly_Incid == "PALISADES") %>%
  select(poly_Incid, poly_Featu) %>% 
  st_buffer(-50)

eaton_in <- st_intersection(eaton_area[1,], eaton_perim_minus50m) %>% 
  mutate(burned = "yes")

eaton_map <- tmap_mode("plot") +
              tm_basemap("Esri.WorldImagery") +
              tm_shape(eaton_fprints_buff) +
              tm_polygons(fill = NULL, col = "red", lwd = 3) +
    tm_compass(type = "4star", position = c("bottom", "right"),bg.color = "white", frame = TRUE, size = 3) +
  tm_scalebar(breaks = c(0, 0.5, 1), text.size = 0.5, position = c("left", "bottom"), bg.color = "white", frame = TRUE) +
  tm_title("Eaton Study Area", position = tm_pos_in(0.35, 0.99), frame = TRUE, bg.color = "white") +
  tm_layout(text.fontfamily = "Times",
            legend.show = F)

eaton_map
#legend.outside = FALSE, legend.position = "none", legend.bg.color = "white",
           # frame = T, legend.width = 4, legend.text.size = 1

tmap_save(eaton_map, "../Figures/eaton_map.png")


```



```{r}


asp_inset <- (400036.6 - 356530.5)/(3786706 - 3766052)

CA <- states() %>% filter(NAME =="California") %>% st_transform(crs = 32611)

study_all <- c(xmax = 400036.6, ymax = 3786706, xmin = 356530.5, ymin = 3766052) %>% st_bbox() %>% st_as_sfc() %>% st_as_sf() 

st_crs(study_all) <- 32611


inset <- tm_shape(CA) +
  tm_polygons(fill = NULL, col = "black") +
    tm_shape(study_all) +
  tm_polygons(fill = NULL, col = "red", fill_alpha = 0.001, border.col = "red", lwd = 2) +
  tm_basemap("CartoDB.Positron") +
  tm_layout(bg.color = "white")

```



```{r, results = "hide", message = FALSE, warning = FALSE, echo=FALSE}

w <- 0.25

h <- asp_inset * w 

vp <- viewport(x=0.96, y=1.06, width = w, height=h, just=c("right", "top"))

tmap_save(eaton_map, "../Figures/inset_map.png", insets_tm = inset, insets_vp = vp)


```



```{r}

pal_in  <- st_intersection(pal_in, palisades_perim_minus50m) %>% 
  mutate(burned = "yes") %>% 
  select(Id = orderDesc, burned)

pal_fprints <- st_read("../tmp_data/palisades_burned_fprints.shp")

pal_fprints_buff <- pal_fprints %>% 
  st_union() %>% 
  st_buffer(50) %>% 
  st_cast("POLYGON") %>% 
  st_as_sf()

pal_map <- tmap_mode("plot") +
              tm_basemap("Esri.WorldImagery") +
              tm_shape(pal_fprints_buff) +
              tm_polygons(fill = NULL, col = "red", lwd = 3) +
  tm_scalebar(breaks = c(0, 0.5, 1), text.size = 0.5, position = c("left", "bottom"), frame = T, bg.color = "white") +
  tm_title("Palisades Study Area", position = tm_pos_in(0.3, 0.99), frame = TRUE, bg.color = "white") +
  tm_layout(text.fontfamily = "Times",
            legend.outside = FALSE, legend.position = c("left", "bottom"), legend.bg.color = "white",
            frame = T, legend.width = 4, legend.text.size = 1)

pal_map

tmap_save(pal_map, "../Figures/pal_map.png")


```


# Canopy and buildings ex


```{r}

tree_crowns_final <- st_read("../tmp_data/eaton_burned_tree_crowns_final.shp")

fprints <- st_read("~/OneDrive - Cal Poly/data/Buildings/LAIAC6_Buildings_2020_Eaton.shp") %>% st_transform(crs = 32611) %>% 
  st_crop(xmin= 392933, ymin= 3781276, xmax= 399091, ymax= 3786441)

max_vis <- terra::rast("~/OneDrive - Cal Poly/Advanced_GIS_data/Maxar/Eaton/PRE/Eaton_prefire_visual/10400100A17E8600-visual (3).tif") %>% 
  terra::project("EPSG:32611")

bbox <- c(xmin = 396300, xmax = 396450,ymin = 3783800, ymax = 3783990)

plot_rect <- st_bbox(bbox, crs = 32611)
# #for raster
rast_rect <- st_bbox(bbox, crs = 32611) %>% st_as_sfc()
map_crowns <- terra::vect(rast_rect)

tree_crop <- st_crop(tree_crowns_final, plot_rect) %>% 
  mutate(class = "tree") %>% 
  select(class)

print_crop <- st_crop(fprints, plot_rect) %>% 
  mutate(class = "building") %>% 
  select(class)

all_crop <- rbind(tree_crop, print_crop)

vis_crop <- terra::crop(max_vis, plot_rect, mask = T)


  tmap_mode("plot")
ex_polys <-  tm_shape(vis_crop) +
 tm_rgb() +
  tm_shape(all_crop) +
  tm_polygons(fill = 'class', fill_alpha = 0.2, fill.scale = tm_scale(values = c("tree" = "lightgreen", "building" = "yellow")), col = 'class', col.scale = tm_scale(values = c("tree" = "lightgreen", "building" = "yellow")), fill.legend = tm_legend_combine("col")) +
   tm_compass(type = "4star", position = c("left", "bottom"), frame = T, bg.color = "white") +
  tm_scalebar(breaks = c(0, 0.01, 0.02), text.size = 0.5, position = c("right", "bottom"), bg.color = "white", frame = T) +
  tm_title("Example Polygons", position = c("top", "center"), frame = TRUE, bg.color = "white") +
  tm_layout(text.fontfamily = "Times", legend.show = T,
           legend.outside = FALSE, legend.position = c("right", "bottom"), legend.bg.color = "white",
            frame = T)
  
tmap_save(ex_polys, "../Figures/Ex_polys.png")



```


# Structure Results Eaton

```{r}

source("~/Desktop/Urban_tree_fire/structure_analysis/Scripts/functions/human_labs.R")


Eaton_struc_spamm_1 <- readRDS("~/Desktop/Urban_tree_fire/structure_analysis/models/eaton_struc_m1_unscaled.rda")

Eaton_struc_spamm_1_scaled <- readRDS("~/Desktop/Urban_tree_fire/structure_analysis/models/eaton_struc_m1_scale.rda")


 coefs_E <- fixef(Eaton_struc_spamm_1_scaled)
  se_E    <- sqrt(diag(vcov(Eaton_struc_spamm_1_scaled)))
  
  
  # Build data frames for each model
  effect_df_E<- data.frame(
    term      = names(coefs_E),
    estimate  = coefs_E,
    std.error = se_E,
    lower     = coefs_E - 1.96 * se_E,
    upper     = coefs_E + 1.96 * se_E,
    fire      = "Eaton",
    stringsAsFactors = FALSE
  )
  
  coefs_scale <- fixef(Eaton_struc_spamm_1_scaled)
  ses   <- sqrt(diag(vcov(Eaton_struc_spamm_1_scaled)))
  
  # build summary data.frame
  df <- data.frame(
    term     = names(coefs_scale),
    estimate = coefs_scale,
    std.error= ses,
    lower    = coefs_scale - 1.96 * ses,
    upper    = coefs_scale + 1.96 * ses,
    stringsAsFactors = FALSE
  )
  
  ordered_terms <- df %>%
    filter(!term %in% c("(Intercept)", "tree_dens", "build_dens")) %>%
    arrange(abs(estimate)) %>%
    pull(term)
  
  ordered_labels <- label_map[ordered_terms]
    
 effect_df_E <- effect_df_E %>%
    mutate(
      significant = (lower > 0) | (upper < 0),
      label       = ifelse(significant, "*", "")
    ) %>%
   filter(!effect_df_E$term %in% c("(Intercept)", "tree_dens", "build_dens")) %>% 
    # Ensure consistent ordering of terms (alphabetical)
    mutate(term = factor(term, levels = ordered_terms, 
                         labels = ordered_labels))
  
  # Create the point + error‐bar plot
  p <- ggplot(effect_df_E, aes(x = term, y = estimate, color = fire)) +
    geom_point() +
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
    geom_text(aes(label = label),
              nudge_y = -0.0001,
              nudge_x = 0.1,
              size = 5) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    coord_flip() +
    labs(
      title = "Standardized effect sizes predicting stucture loss Eaton",
      x     = "Predictor",
      y     = "Estimate (± 95% CI)"
    ) +
    scale_color_manual(values = c("#440154FF" , "#21908CFF")) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), 
          axis.text = element_markdown(),
          title = element_markdown(),
          legend.position = "none")
  

  
  p2 <- plot_effects_mag(
    Eaton_struc_spamm_1_scaled ,
    plot_title = "", 
    bar_fill = "#440154FF", label_map = label_map
  ) +
    theme(
      axis.title.y    = element_blank(),
      axis.text.y     = element_blank(),
      axis.ticks.y    = element_blank(),
      axis.title.x    = element_blank(),
      axis.text.x     = element_blank(),
      axis.ticks.x    = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )
  
  # 3) Combine with aligned y‐axes, 6:1 width ratio
plot_grid(
    p, p2,
    ncol       = 2,
    rel_widths = c(6, 1),
    align      = "h",
    axis       = "y"
  )
  
  ggsave("../Figures/Stucture_loss_Eaton.png", width = 7, height = 5)

```

## Var importance Eaton


```{r}

source("functions/coef_mag.R")
source("functions/human_labs.R")


eaton_wind <- read.csv("../wind_data/all_hrrr.csv") %>% 
  filter(point_fire == "eaton") %>% group_by(point_UID) %>% 
  summarize(mean_wind_sp = mean(wdsp), 
            mean_wind_dir = mean(wdir))

eaton_areas <- read.csv("../model_inputs/eaton_burned_alt_inputs.csv")


Eaton_struc <- read.csv("../model_inputs/eaton_burned_struc_model_inputs.csv") %>% 
  select(-X) %>% 
  filter(DAMAGE %in% c("Destroyed (>50%)", "No Damage", "Affected (1-9%)")) %>% 
  na.omit() %>% 
  left_join(eaton_wind, by = c("UID" = "point_UID")) %>% 
  left_join(eaton_areas, by = "UID")

Eaton_struc <- Eaton_struc %>% mutate(angular_diff_build = pmin(abs(bearing_to_nearest_building - mean_wind_dir), 360 - abs(bearing_to_nearest_building - mean_wind_dir)), angular_diff_tree = pmin(abs(bearing_to_nearest_tree - mean_wind_dir), 360 - abs(bearing_to_nearest_tree - mean_wind_dir)), destroyed = if_else(DAMAGE %in% c("No Damage", "Affected (1-9%)"),0,1))

cols <- c("distance_to_nearest_tree", "distance_to_nearest_building", "angular_diff_tree", "number_of_trees_2m", "number_of_trees_5m", "number_of_trees_10m",  "area_of_trees_2m",  "area_of_trees_5m",  "area_of_trees_10m", "area_ext_build_2", "area_ext_build_10", "area_ext_build_25", "area_ext_build_50", "area_ext_build_100", "angular_diff_build", "build_dens", "tree_dens", "mean_perc_struc", "area_tree_200m", "total_build_200_m", "fprint_area", "num_trees_200m", "mean_tree_density", "mean_struc_density", "num_builds_200m", "tree_dens_500", "tree_dens_1000", "area_tree_100m", "area_tree_50m", "total_build_100_m", "build_dens_500", "build_dens_1000", "total_build_50_m")

names(cols) <- cols

Eaton_struc_scale <- mutate(Eaton_struc, across(all_of(cols), ~ scale(.x, center = T)))

spd <- sp::SpatialPointsDataFrame(
  coords = Eaton_struc[, c("utm_x", "utm_y")],
  data = Eaton_struc)

bound <- inla.nonconvex.hull(spd, convex = -.01, resolution = c(105,82))

mesh <- inla.mesh.2d(boundary = bound, max.edge = 200)

# Create SPDE model
spde <- INLA::inla.spde2.matern(mesh)

spaMM.options(separation_max = 100) # or even higher if suggested

eaton_scaled_m <- fitme(destroyed ~ distance_to_nearest_tree + angular_diff_tree + tree_dens * 
                         build_dens + distance_to_nearest_building + angular_diff_build + 
                         area_ext_build_2 + area_of_trees_2m +IMRF(1 | utm_x + utm_y, 
                                                                   model = spde), 
                       data = Eaton_struc_scale, family = binomial(link = "logit"))


eaton_imp <- plot_effects_mag(eaton_scaled_m, label_map = label_map, bar_fill = "black", plot_title = "A. Predictor Importance: Eaton") + theme(axis.text = element_markdown())

#ggsave("../Figures/eaton_var_importance.png")


```



```{r}

source("functions/make_model_table_struc.R")

Eaton_struc_tab <- make_model_table_struc(scaled_model = eaton_scaled_m, unscaled_model = Eaton_struc_spamm_1, label_map = label_map)

Eaton_struc_tab$fire = "Eaton"


```

# Structure results Palisades


```{r}

source("~/Desktop/Urban_tree_fire/structure_analysis/Scripts/functions/human_labs.R")


Palisades_struc_spamm_1 <- readRDS("~/Desktop/Urban_tree_fire/structure_analysis/models/Palisades_struc_m1_unscaled.rda")

Palisades_struc_spamm_1_scaled <- readRDS("~/Desktop/Urban_tree_fire/structure_analysis/models/Palisades_struc_m1_scaled.rda")

coefs_P <- fixef(Palisades_struc_spamm_1_scaled)
  se_P   <- sqrt(diag(vcov(Palisades_struc_spamm_1_scaled)))
  
 effect_df_P <- data.frame(
    term      = names(coefs_P),
    estimate  = coefs_P,
    std.error = se_P,
    lower     = coefs_P - 1.96 * se_P,
    upper     = coefs_P + 1.96 * se_P,
    fire      = "Palisades",
    stringsAsFactors = FALSE
  )
 
   ordered_terms <- effect_df_P %>%
    filter(!term %in% c("(Intercept)", "tree_dens", "build_dens")) %>%
    arrange(abs(estimate)) %>%
    pull(term)
   
   ordered_labels <- label_map[ordered_terms]
 
  effect_df_P <- effect_df_P %>%
    mutate(
      significant = (lower > 0) | (upper < 0),
      label       = ifelse(significant, "*", "")
    ) %>%
   filter(!effect_df_P$term %in% c("(Intercept)", "tree_dens", "build_dens")) %>% 
    # Ensure consistent ordering of terms (alphabetical)
    mutate(term = factor(term, levels = ordered_terms, 
                         labels = ordered_labels))
  
  # Create the point + error‐bar plot
  p <- ggplot(effect_df_P, aes(x = term, y = estimate, color = fire)) +
    geom_point() +
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
    geom_text(aes(label = label),
              nudge_y = -0.0001,
              nudge_x = 0.1,
              size = 5) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    coord_flip() +
    labs(
      title = "Standardized effect sizes predicting stucture loss Palisades",
      x     = "Predictor",
      y     = "Estimate (± 95% CI)"
    ) +
    scale_color_manual(values = c("#21908CFF")) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), 
          axis.text = element_markdown(),
          legend.position = "none")
  
p2 <- plot_effects_mag(
    Palisades_struc_spamm_1_scaled,
    plot_title = "", 
    bar_fill = "#21908CFF",
    label_map = label_map
  ) +
    theme(
      axis.title.y    = element_blank(),
      axis.text.y     = element_blank(),
      axis.ticks.y    = element_blank(),
      axis.title.x    = element_blank(),
      axis.text.x     = element_blank(),
      axis.ticks.x    = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )
  
  # 3) Combine with aligned y‐axes, 6:1 width ratio
plot_grid(
    p, p2,
    ncol       = 2,
    rel_widths = c(6, 1),
    align      = "h",
    axis       = "y"
  )
  
  ggsave("../Figures/Stucture_loss_Palisades.png", width = 7, height = 5)



``` 


## Var importance Palisades
```{r}
# Palisades Struc

source("functions/coef_mag.R")
source("functions/human_labs.R")

pal_wind <- read.csv("../wind_data/all_hrrr.csv") %>% 
  filter(point_fire == "palisades") %>% group_by(point_UID) %>% 
  summarize(mean_wind_sp = mean(wdsp), 
            mean_wind_dir = mean(wdir))

pal_areas <- read.csv("../model_inputs/palisades_burned_alt_inputs.csv")


Palisades_struc <- read.csv("../model_inputs/palisades_burned_struc_model_inputs.csv") %>% 
  filter(DAMAGE %in% c("Destroyed (>50%)", "No Damage", "Affected (1-9%)")) %>% 
  left_join(pal_wind, by = c("UID" = "point_UID")) %>% 
  left_join(pal_areas, by = "UID")
# make new columns

Palisades_struc <- Palisades_struc %>% mutate(angular_diff_build = pmin(abs(bearing_to_nearest_building - mean_wind_dir), 360 - abs(bearing_to_nearest_building - mean_wind_dir)), angular_diff_tree = pmin(abs(bearing_to_nearest_tree - mean_wind_dir), 360 - abs(bearing_to_nearest_tree - mean_wind_dir)), destroyed = if_else(DAMAGE %in% c("No Damage", "Affected (1-9%)"),0,1))


cols <- c("distance_to_nearest_tree", "distance_to_nearest_building", "angular_diff_tree", "number_of_trees_2m", "number_of_trees_5m", "number_of_trees_10m",  "area_of_trees_2m",  "area_of_trees_5m",  "area_of_trees_10m", "area_ext_build_2", "area_ext_build_10", "area_ext_build_25", "area_ext_build_50", "area_ext_build_100", "angular_diff_build", "build_dens", "tree_dens", "mean_perc_struc", "area_tree_200m", "total_build_200_m", "num_trees_200m", "mean_tree_density", "mean_struc_density", "num_builds_200m", "tree_dens_500", "tree_dens_1000", "area_tree_100m", "area_tree_50m", "total_build_50_m")

names(cols) <- cols

Palisades_struc_scale <- mutate(Palisades_struc, across(all_of(cols), ~ scale(.x, center = T)))




spd <- sp::SpatialPointsDataFrame(
  coords = Palisades_struc[, c("utm_x", "utm_y")],
  data = Palisades_struc)

bound <- inla.nonconvex.hull(spd, convex = -.05)

mesh <- inla.mesh.2d(boundary = bound, max.edge = 250)

# Create SPDE model
spde <- INLA::inla.spde2.matern(mesh)

spaMM.options(separation_max = 100)


pal_scaled_m <- fitme(destroyed ~ distance_to_nearest_tree + angular_diff_tree + tree_dens * 
                                   build_dens + distance_to_nearest_building + angular_diff_build + 
                                   area_ext_build_2 + area_of_trees_2m +IMRF(1 | utm_x + utm_y, 
                                                                             model = spde), 
                                 data = Palisades_struc_scale, family = binomial(link = "logit"))


pal_imp <- plot_effects_mag(model = pal_scaled_m, label_map = label_map, bar_fill = "black", plot_title = "B. Predictor Importance: Palisades") + 
  theme(axis.text = element_markdown())

#ggsave("../Figures/pal_var_importance.png")

imp_plots <- arrangeGrob(eaton_imp, pal_imp, layout_matrix = rbind(c(1,2)))

ggsave("../Figures/var_importance.png", imp_plots, width = 6, height = 2, units = "in", dpi = 300)
```



```{r}

Pal_struc_tab <- make_model_table_struc(scaled_model = pal_scaled_m, unscaled_model = Palisades_struc_spamm_1, label_map = label_map)

Pal_struc_tab$fire = "Palisades"

all_struc_tab <- rbind(Eaton_struc_tab, Pal_struc_tab)

all_struc_tab_wide <- left_join(Eaton_struc_tab, Pal_struc_tab, by = "term")

write.csv(all_struc_tab, "../Figures/all_struc_tab.csv")

write.csv(all_struc_tab_wide, "../Figures/all_struc_tab_wide.csv")
```


# Tree Density Eaton


```{r}

source("functions/simple_slopes.R")

p1 <- simple_slopes_plot(Eaton_struc_spamm_1, x="tree_dens", modx="build_dens", modx_vals=c("Q10","Q90"), xlim = max(Eaton_struc_spamm_1$data$tree_dens))
p1 +
    scale_color_manual(name = "Structure density", values = c("forestgreen", "black")) + 
  scale_fill_manual(name = "Structure density", values = c("forestgreen", "black")) +
  labs(y = "Predicted probability of structure loss",
       x = "Tree density (ha <sup>-1</sup>)",
         title = "Predicted slope of tree density at high and low structure density: Eaton") +
    theme_classic() +
    theme(axis.title.x = element_markdown())

ggsave("../Figures/Eaton_interaction.png", width = 7, height = 5)
```

# Struc Density Eaton


```{r}

source("functions/simple_slopes.R")

p1 <- simple_slopes_plot(Eaton_struc_spamm_1, x="build_dens", modx="tree_dens", modx_vals=c("Q10","Q90"), xlim = max(Eaton_struc_spamm_1$data$build_dens))
p1 +
    scale_color_manual(name = "Tree density", values = c("forestgreen", "black")) + 
  scale_fill_manual(name = "Tree density", values = c("forestgreen", "black")) +
  labs(y = "Predicted probability of structure loss",
       x = "Structure density (ha <sup>-1</sup>)",
         title = "Predicted slope of structure density at high and low tree density: Eaton")
    theme_classic() +
  theme(axis.title.x = element_markdown())

#ggsave("../Figures/Eaton_interaction.png", width = 7, height = 5)
```

# Tree density Palisades


```{r}

source("functions/simple_slopes.R")

p1 <- simple_slopes_plot(Palisades_struc_spamm_1, x="tree_dens", modx="build_dens", modx_vals=c("Q10","Q90"), xlim = max(Palisades_struc_spamm_1$data$tree_dens))
p1 + 
  scale_color_manual(name = "Structure density", values = c("forestgreen",  "black")) + 
  scale_fill_manual(name = "Structure density", values = c("forestgreen", "black")) +
  labs(y = "Predicted probability of structure loss",
       x = "Tree density (ha <sup>-1</sup>)",
         title = "Predicted slope of tree density at high and low structure density: Palisades") +
    theme_classic() +
  theme(axis.title.x = element_markdown())

ggsave("../Figures/Palisades_interaction.png", width = 7, height = 5)
  
```

# Struc density Palisades


```{r}

source("functions/simple_slopes.R")

p1 <- simple_slopes_plot(Palisades_struc_spamm_1, x="build_dens", modx="tree_dens", modx_vals=c("Q10","Q90"), xlim = max(Palisades_struc_spamm_1$data$build_dens))
p1 + 
  scale_color_manual(name = "Tree density", values = c("forestgreen",  "black")) + 
  scale_fill_manual(name = "Tree density", values = c("forestgreen", "black")) +
  labs(y = "Predicted probability of structure loss",
       x = "Structure density",
         title = "Predicted slope of strucutre density at high and low tree density: Palisades",
         subtitle = "Lines = fitted values, bands = 95% CI") +
    theme_classic()

#ggsave("../Figures/Palisades_interaction.png", width = 7, height = 5)
  
```


## Eaton all sig vars marginal plots

```{r}

source("functions/plot_pred_change.R")

e_dens <- plot_pred_change(Eaton_struc_spamm_1, var = "build_dens") + 
  labs(x = "Structure density (1/ha)")

e_tree_dens <- plot_pred_change(Eaton_struc_spamm_1, var = "tree_dens") + 
  labs(x = "Tree density (1/ha)")

e_trees_2 <- plot_pred_change(Eaton_struc_spamm_1, var = "area_of_trees_2m") +
  labs(x = "Area of tree canopy within 2 m")

e_dist <- plot_pred_change(Eaton_struc_spamm_1, var = "distance_to_nearest_building") +
  labs(x = "Distance to nearest structure")

e_build_2 <- plot_pred_change(Eaton_struc_spamm_1, var = "area_ext_build_2") +
  labs(x = "Area of structure footprint within 2 m")

e_marg_plots <- arrangeGrob(e_dens, e_tree_dens, e_trees_2, e_dist, e_build_2, layout_matrix = rbind(c(1,2), 
                                                                                        c(3,4), 
                                                                                        c(5, NA)))

ggsave("../Figures/eaton_marg_prob.png", e_marg_plots, width = 6, height = 8, units = "in")
```


## Palisades all sig vars marginal plots

```{r}

source("functions/plot_pred_change.R")

p_dens <- plot_pred_change(Palisades_struc_spamm_1, var = "build_dens") + 
  labs(x = "Structure density (1/ha)")

p_tree_dens <- plot_pred_change(Palisades_struc_spamm_1, var = "tree_dens") + 
  labs(x = "Tree density (1/ha)")

p_trees_2 <- plot_pred_change(Palisades_struc_spamm_1, var = "area_of_trees_2m") +
  labs(x = "Area of tree canopy within 2 m")

p_dist <- plot_pred_change(Palisades_struc_spamm_1, var = "distance_to_nearest_building") +
  labs(x = "Distance to nearest structure")

p_marg_plots <- arrangeGrob(p_dens, p_tree_dens, p_trees_2, p_dist, layout_matrix = rbind(c(1,2), 
                                                                                        c(3,4)))

ggsave("../Figures/palisades_marg_prob.png", p_marg_plots)
```


## All sig vars marginal plots
```{r}

source("functions/plot_pred_change_2.R")

struc_dens <- plot_pred_change(Eaton_struc_spamm_1, Palisades_struc_spamm_1, var = "build_dens",
                 labels = c("Eaton", "Palisades"), delta = 1) + 
  labs(x = "Structure density (ha<sup>-1</sup>)")  +
  scale_color_manual(values = c("#0D0887FF", "#ED7953FF")) +
  scale_fill_manual(values = c("#0D0887FF","#ED7953FF")) +
  theme(legend.position = "none", 
        axis.title = element_markdown()) 


tree_dens <- plot_pred_change(Eaton_struc_spamm_1, Palisades_struc_spamm_1, var = "tree_dens",
                 labels = c("Eaton", "Palisades"), delta = 1) +
  labs(x = "Tree density (ha<sup>-1</sup>)") +
    scale_color_manual(values = c("#0D0887FF", "#ED7953FF")) +
  scale_fill_manual(values = c("#0D0887FF","#ED7953FF")) +
  theme(legend.position = "none", 
        axis.title = element_markdown())

trees_2 <- plot_pred_change(Eaton_struc_spamm_1, Palisades_struc_spamm_1, var = "area_of_trees_2m",
                 labels = c("Eaton", "Palisades"), delta = 1) + 
  labs(x = "Area of tree canopy within 2 m (m<sup>2</sup>)")  +
    scale_color_manual(values = c("#0D0887FF", "#ED7953FF")) +
  scale_fill_manual(values = c("#0D0887FF","#ED7953FF")) +
  theme(legend.position = "none", 
        axis.title = element_markdown())

dist <- plot_pred_change(Eaton_struc_spamm_1, Palisades_struc_spamm_1, var = "distance_to_nearest_building",
                 labels = c("Eaton", "Palisades"), delta = 1) + 
  labs(x = "Distance to nearest structure (m)")  +
    scale_color_manual(values = c("#0D0887FF", "#ED7953FF")) +
  scale_fill_manual(values = c("#0D0887FF","#ED7953FF")) +
  theme(legend.position = "none", 
        axis.title = element_markdown())

build_2 <- plot_pred_change(Eaton_struc_spamm_1, Palisades_struc_spamm_1, var = "area_ext_build_2",
                 labels = c("Eaton", "Palisades"), delta = 1) + 
  labs(x = "Area of structure footprint within 2 m (m<sup>2</sup>)")   +
    scale_color_manual(values = c("#0D0887FF", "#ED7953FF")) +
  scale_fill_manual(values = c("#0D0887FF","#ED7953FF")) +
  theme(legend.position = "none", 
        axis.title = element_markdown())



legend <- get_legend(plot_pred_change(Eaton_struc_spamm_1, Palisades_struc_spamm_1, var = "area_ext_build_2",
                 labels = c("Eaton", "Palisades"), delta = 1) + 
  labs("Area of structure footprint within 2 m") +
      scale_color_manual(values = c("#0D0887FF", "#ED7953FF")) +
  scale_fill_manual(values = c("#0D0887FF","#ED7953FF")) +
    theme(legend.title = element_text(size = 16), 
          legend.text = element_text(size = 16), 
  legend.key.size = unit(1.5, "cm")))


marg_plots <- arrangeGrob(struc_dens, tree_dens, trees_2, dist, build_2, legend, layout_matrix = rbind(c(1,2), 
                                                                                        c(3,4), 
                                                                                        c(5, 6)))

ggsave("../Figures/marg_prob.png", marg_plots, width = 6, height = 8, units = "in")

```






# Correlation matrix

```{r}

Eaton_cor <- Eaton_struc_spamm_1_scaled$data %>%
  select(distance_to_nearest_building, distance_to_nearest_tree, angular_diff_build, angular_diff_tree, area_of_trees_2m, area_ext_build_2, tree_dens, build_dens)

M <- cor(Eaton_cor, use = "complete.obs")
M_melt <- melt(M)

cor_plot <- ggplot(M_melt, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", value)), size = 3) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "", y = "", fill = "Correlation") +
  ggtitle("Correlation Matrix of predictors for Eaton fire")


ggsave("../Supp_Figures/Eaton_corrplot_gg.png", cor_plot, width = 6, height = 4, dpi = 300)

check_collinearity(Eaton_struc_spamm_1_scaled)

```




```{r}

Pal_cor <- Palisades_struc_spamm_1_scaled$data %>%
  select(distance_to_nearest_building, distance_to_nearest_tree, angular_diff_build, angular_diff_tree, area_of_trees_2m, area_ext_build_2, tree_dens, build_dens)


M <- cor(Pal_cor, use = "complete.obs")
M_melt <- melt(M)

cor_plot <- ggplot(M_melt, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", value)), size = 3) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "", y = "", fill = "Correlation") +
  ggtitle("Correlation Matrix of predictors for Palisades fire")

ggsave("../Supp_Figures/Palisades_corrplot_gg.png", cor_plot, width = 6, height = 4, dpi = 300)

check_collinearity(Palisades_struc_spamm_1)

```


# Tree and Structure density maps

# Eaton tree density

```{r}

eaton_fprints <- st_read("../tmp_data/eaton_burned_fprints.shp") %>% 
  left_join(Eaton_struc_spamm_1$data, by = "UID")

eaton_burn_crowns <- st_read("../tmp_data/eaton_burned_tree_crowns_final.shp")

Eaton_tree_crowns <- st_read("../tmp_data/eaton_crowns_burned_polys_v2.shp")

eaton_fprints_buff <- eaton_fprints %>% 
  st_union() %>% 
  st_buffer(50) %>% 
  st_cast("POLYGON") %>% 
  st_as_sf()

make_ref <- function(boundary, res = 30) {
  rast(ext(vect(boundary)), resolution = res, crs = st_crs(boundary)$wkt)
}

ref_eaton <- make_ref(Eaton_tree_crowns, res = 30)

k_eaton_pdf <- sf.kde(
  x = st_centroid(Eaton_tree_crowns),
  bw = 200, ref = ref_eaton, standardize = FALSE, scale.factor = 1, mask = FALSE, res = 30
)

n_eaton <- nrow(Eaton_tree_crowns)

k_eaton_int_m2 <- k_eaton_pdf * n_eaton

k_eaton_tpha <- k_eaton_int_m2 * 10000

k_eaton_tpha_crop <- terra::crop(k_eaton_tpha, eaton_fprints_buff, mask = T)


terra::global(k_eaton_tpha_crop, fun="mean", na.rm = T)[,1]

nrow(eaton_burn_crowns)/st_area(st_union(eaton_fprints_buff)) *10000

# Plot with continuous scale
tmap_mode("plot")
eaton_tree_dens_map <- tm_shape(k_eaton_tpha_crop) + 
  tm_raster(
    style = "cont",          # continuous scale
    palette = "-viridis",    # optional, reversed viridis for visual contrast
    title = "Tree Density", 
    alpha = 1
  ) +
  tm_layout(
    legend.outside = TRUE,
    legend.text.size = 0.8,
    legend.title.size = 1, 
    title = "Eaton Tree Kernel Density", 
    title.position = c("top", "right")
  )

tmap_save(eaton_tree_dens_map, "../Supp_Figures/Eaton_tree_dens.png")


eaton_tree_dens_map
```



# Eaton struc density

```{r}

eaton_fprints <- st_read("../tmp_data/eaton_burned_fprints.shp") %>% 
  left_join(Eaton_struc_spamm_1$data, by = "UID")

eaton_fprints_buff <- eaton_fprints %>% 
  st_union() %>% 
  st_buffer(50) %>% 
  st_cast("POLYGON") %>% 
  st_as_sf()


Eaton_fprints_all <- st_read("~/OneDrive - Cal Poly/data/Buildings/LARIAC6_Buildings_2020_eaton.shp") %>% 
  st_transform(32611)


make_ref <- function(boundary, res = 30) {
  rast(ext(vect(boundary)), resolution = res, crs = st_crs(boundary)$wkt)
}

ref_eaton_fprints <- make_ref(Eaton_fprints_all, res = 30)

k_eaton_prints_pdf <- sf.kde(
  x = st_centroid(Eaton_fprints_all),
  bw = 200, ref = ref_eaton_fprints, standardize = FALSE, scale.factor = 1, mask = FALSE, res = 30
)

n_eaton_prints <- nrow(Eaton_fprints_all)

k_eaton_prints_int_m2 <- k_eaton_prints_pdf * n_eaton_prints

k_eaton_prints_spha <- k_eaton_prints_int_m2 * 10000

k_eaton_prints_spha_crop <- terra::crop(k_eaton_prints_spha, eaton_fprints_buff, mask = T)

terra::global(k_eaton_prints_spha_crop, fun="mean", na.rm = T)[,1]

nrow(eaton_fprints)/st_area(st_union(eaton_fprints_buff)) *10000

# Plot with continuous scale
tmap_mode("plot")
eaton_struc_dens_map <- tm_shape(k_eaton_prints_spha_crop) + 
  tm_raster(
    style = "cont",          # continuous scale
    palette = "-viridis",    # optional, reversed viridis for visual contrast
    title = "Struc Density", 
    alpha = 1
  ) +
  tm_layout(
    legend.outside = TRUE,
    legend.text.size = 0.8,
    legend.title.size = 1, 
    title = "Eaton structure kernel density", 
    title.position = c("top", "right")
  )

tmap_save(eaton_struc_dens_map, "../Supp_Figures/eaton_struc_dens.png")

```
 
 

# Pal tree density


```{r}

pal_fprints <- st_read("../tmp_data/palisades_burned_fprints.shp")

pal_fprints_buff <- pal_fprints %>% 
  st_union() %>% 
  st_buffer(50) %>% 
  st_cast("POLYGON") %>% 
  st_as_sf()


pal_tree_crowns <- st_read("../tmp_data/palisades_crowns_burned_polys_v2.shp")


make_ref <- function(boundary, res = 30) {
  rast(ext(vect(boundary)), resolution = res, crs = st_crs(boundary)$wkt)
}

ref_pal <- make_ref(pal_tree_crowns, res = 30)

k_pal_pdf <- sf.kde(
  x = st_centroid(pal_tree_crowns),
  bw = 200, ref = ref_pal, standardize = FALSE, scale.factor = 1, mask = FALSE, res = 30
)

n_pal <- nrow(pal_tree_crowns)

k_pal_int_m2 <- k_pal_pdf * n_pal

k_pal_tpha <- k_pal_int_m2 * 10000

k_pal_tpha_crop <- terra::crop(k_pal_tpha, pal_fprints_buff, mask = T)

terra::global(k_pal_tpha_crop, fun="mean", na.rm = T)[,1]

# alt mean

pal_burned_tree_crowns <- st_read("../tmp_data/palisades_burned_tree_crowns_final.shp")

nrow(pal_burned_tree_crowns)/st_area(st_union(pal_fprints_buff))*10000


# Plot with continuous scale
tmap_mode("plot")
pal_tree_dens_map <- tm_shape(k_pal_tpha_crop) + 
  tm_raster(
    style = "cont",          # continuous scale
    palette = "-viridis",    # optional, reversed viridis for visual contrast
    title = "Tree Density", 
    alpha = 1
  ) +
  tm_layout(
    legend.outside = TRUE,
    legend.text.size = 0.8,
    legend.title.size = 1, 
    title = "Palisades Tree Kernel Density", 
    title.position = c("top", "right")
  )

#tmap_save(pal_tree_dens_map, "../Supp_Figures/Palisades_tree_dens.png")

pal_tree_dens_map

```

# Pal struc density

```{r}

pal_fprints <- st_read("../tmp_data/palisades_burned_fprints.shp") %>% 
  left_join(Palisades_struc_spamm_1$data, by = "UID")

pal_fprints_buff <- pal_fprints %>% 
  st_union() %>% 
  st_buffer(50) %>% 
  st_cast("POLYGON") %>% 
  st_as_sf()


pal_fprints_all <- st_read("~/OneDrive - Cal Poly/data/Buildings/LARIAC6_Buildings_2020_palisades.shp") %>% 
  st_transform(32611)

make_ref <- function(boundary, res = 30) {
  rast(ext(vect(boundary)), resolution = res, crs = st_crs(boundary)$wkt)
}

ref_pal_fprints <- make_ref(pal_fprints_all, res = 30)

k_pal_prints_pdf <- sf.kde(
  x = st_centroid(pal_fprints_all),
  bw = 200, ref = ref_pal_fprints, standardize = FALSE, scale.factor = 1, mask = FALSE, res = 30
)

n_pal_prints <- nrow(pal_fprints_all)

k_pal_prints_int_m2 <- k_pal_prints_pdf * n_pal_prints

k_pal_prints_spha <- k_pal_prints_int_m2 * 10000

k_pal_prints_spha_crop <- terra::crop(k_pal_prints_spha, pal_fprints_buff, mask = T)

terra::global(k_pal_prints_spha_crop, fun="mean", na.rm = T)[,1]

nrow(pal_fprints)/st_area(st_union(pal_fprints_buff)) *10000


# Plot with continuous scale
tmap_mode("plot")
pal_struc_dens_map <- tm_shape(k_pal_prints_spha_crop) + 
  tm_raster(
    style = "cont",          # continuous scale
    palette = "-viridis",    # optional, reversed viridis for visual contrast
    title = "Struc Density", 
    alpha = 1
  ) +
  tm_layout(
    legend.outside = TRUE,
    legend.text.size = 0.8,
    legend.title.size = 1, 
    title = "Palisades Structure Kernel Density", 
    title.position = c("top", "right")
  )

tmap_save(pal_struc_dens_map, "../Supp_Figures/Palisades_struc_dens.png")

```




# Burned vs unburned summary stats

```{r}

Eaton_dest_sum <- Eaton_struc_spamm_1$data %>% select(destroyed, build_dens, tree_dens, distance_to_nearest_tree, distance_to_nearest_building, area_of_trees_2m, area_ext_build_2) %>% 
  group_by(destroyed) %>% 
  summarize(mean_build_dens = mean(build_dens), 
            sd_build_dens = sd(build_dens),
            mean_tree_dens = mean(tree_dens), 
            sd_tree_dens = sd(tree_dens),
            mean_distance_to_nearest_building = mean(distance_to_nearest_building), 
            sd_distance_to_nearest_building = sd(distance_to_nearest_building),
            mean_distance_to_nearest_tree = mean(distance_to_nearest_tree), 
            sd_distance_to_nearest_tree = sd(distance_to_nearest_tree),
            mean_area_of_trees_2m = mean(area_of_trees_2m), 
            sd_area_of_trees_2m = sd(area_of_trees_2m),
            mean_area_ext_build_2m = mean(area_ext_build_2),
            sd_area_ext_build_2m = sd(area_ext_build_2))

Eaton_dest_sum_long <- pivot_longer(Eaton_dest_sum, cols = 2:13)

Eaton_dest_sum_long <- Eaton_dest_sum %>%
  mutate(destroyed = factor(destroyed, levels = c(0, 1),
                            labels = c("Not destroyed", "Destroyed"))) %>%
  pivot_longer(
    cols = -destroyed,
    names_to = c(".value", "var"),          # creates 'mean' and 'sd' cols
    names_pattern = "^(mean|sd)_(.*)$"
  )

eaton_p_facets <- ggplot(Eaton_data,
                   aes(x = destroyed, y = mean, fill = destroyed)) +
  geom_violin(width = 0.8) +
  geom_errorbar(aes(ymin = pmax(mean - sd, 0), ymax = mean + sd),
                width = 0.2) +
  facet_wrap(~ var, scales = "free_y") +      # different units → allow free y
  labs(x = NULL, y = "Mean (± 1 SD)",
       title = "Eaton") +
  guides(fill = "none") +
  theme_minimal(base_size = 12) +
  scale_fill_manual(values = c("forestgreen", "red"))

ggsave("../Supp_Figures/eaton_sum_stats.png", eaton_p_facets)

eaton_p_facets

Eaton_data <- Eaton_struc_spamm_1$data %>% select(destroyed, build_dens, tree_dens, distance_to_nearest_tree, distance_to_nearest_building, area_of_trees_2m, area_ext_build_2)

Eaton_data_long <- Eaton_data %>% pivot_longer(cols = 2:7)

ggplot(Eaton_data_long, aes(x = as.factor(destroyed), y = value)) + 
  geom_violin() + 
  facet_wrap(~ name, scales = "free_y")


```


```{r}

Pal_dest_sum <- Palisades_struc %>% select(destroyed, build_dens, tree_dens, distance_to_nearest_tree, distance_to_nearest_building, area_of_trees_2m, area_ext_build_2) %>% 
  group_by(destroyed) %>% 
  summarize(mean_build_dens = mean(build_dens), 
            sd_build_dens = sd(build_dens),
            mean_tree_dens = mean(tree_dens), 
            sd_tree_dens = sd(tree_dens),
            mean_distance_to_nearest_building = mean(distance_to_nearest_building), 
            sd_distance_to_nearest_building = sd(distance_to_nearest_building),
            mean_distance_to_nearest_tree = mean(distance_to_nearest_tree), 
            sd_distance_to_nearest_tree = sd(distance_to_nearest_tree),
            mean_area_of_trees_2m = mean(area_of_trees_2m), 
            sd_area_of_trees_2m = sd(area_of_trees_2m),
            mean_area_ext_build_2m = mean(area_ext_build_2),
            sd_area_ext_build_2m = sd(area_ext_build_2))

Pal_dest_sum_long <- pivot_longer(Pal_dest_sum, cols = 2:13)

Pal_dest_sum_long <- Pal_dest_sum %>%
  mutate(destroyed = factor(destroyed, levels = c(0, 1),
                            labels = c("Not destroyed", "Destroyed"))) %>%
  pivot_longer(
    cols = -destroyed,
    names_to = c(".value", "var"),          # creates 'mean' and 'sd' cols
    names_pattern = "^(mean|sd)_(.*)$"
  )

pal_p_facets <- ggplot(Pal_dest_sum_long,
                   aes(x = destroyed, y = mean, fill = destroyed)) +
  geom_col(width = 0.8) +
  geom_errorbar(aes(ymin = pmax(mean - sd, 0), ymax = mean + sd),
                width = 0.2) +
  facet_wrap(~ var, scales = "free_y") +      # different units → allow free y
  labs(x = NULL, y = "Mean (± 1 SD)",
       title = "Palisades") +
  guides(fill = "none") +
  theme_minimal(base_size = 12) +
  scale_fill_manual(values = c("forestgreen", "red"))

ggsave("../Supp_Figures/pal_sum_stats.png", pal_p_facets)

pal_p_facets

pal_data <- Palisades_struc_spamm_1$data %>% select(destroyed, build_dens, tree_dens, distance_to_nearest_tree, distance_to_nearest_building, area_of_trees_2m, area_ext_build_2)

pal_data_long <- pal_data %>% pivot_longer(cols = 2:7)

ggplot(pal_data_long, aes(x = as.factor(destroyed), y = value)) + 
  geom_violin() + 
  facet_wrap(~ name, scales = "free_y")




```


